# 目的

> 由于android源码开发编译很耗时间，每次修改代码编译最快需要十几分种。所以想快速编译出我们想要的库和可执行文件。这可以显著提高我们效率。
>
> 所以才会研究android的native编译流程。c/c++编译大致分为预处理阶段、编译阶段、汇编阶段、链接阶段

# 编译流程

> 预处理阶段：预处理阶段对包含源代码的文本文件（[test.cc](http://test.cc)）处理，比如包含头文件到文件中，替换宏定义。生成预处理后的文件`test.i`
>
> 编译阶段：编译器将预处理生成的文件翻译成汇编程序(test.s)，汇编语言程序中的每条语句都以一种标准的文本格式确切的描述一条低级机器语言指令。汇编语言能为不同高级语言的不同编译器提供通用的输出语言。
>
> 汇编阶段：汇编器as将`test.s`翻译成机器语言，把这些指令打包成一种可重定位的目标程序格式，将结果保存在目标文件`test.o`中。
>
> 链接阶段:再`test.cc` 程序中调用了系统函数`cout`，链接器将改函数的目标文件`cout.o` 合并到`test.o`程序中生成可执行的目标程序。



# 如何获取快速编译方法。

> 编译audio_hw.c方法

```c++
//每次源码更新后，编译器会重新把相应的代码文件(如:audio_hw.c)翻译成相应的.o文件(如：audio_hw.o);然后编译器再把这些.o文件和相应库链接起来，组成我们所需的库或者可执行文件。

//获取.o文件的方法：在代码中添加语法错误，然后编译代码，会报错。从编译Log中可以看出具体的编译方法。
/bin/bash -c "PWD=/proc/self/cwd vendor/qcom/proprietary/llvm-arm-toolchain-ship/8.0/bin/clang 	-I external/tinyalsa/include -I external/tinycompress/include -I system/media/audio_utils/include -I external/expat/lib -I vendor/qcom/opensource/core-utils/fwk-detect -I system/media/audio_route/include -I system/media/audio_effects/include -I vendor/qcom/opensource/audio-hal/primary-hal/hal/msm8974 -I vendor/qcom/opensource/audio-hal/primary-hal/hal/audio_extn -I vendor/qcom/opensource/audio-hal/primary-hal/hal/voice_extn -I out/target/product/sdm660_64/obj/KERNEL_OBJ/usr/include -I out/target/product/sdm660_64/obj/KERNEL_OBJ/usr/techpack/audio/include -I out/target/product/sdm660_64/obj/KERNEL_OBJ/usr/include -I out/target/product/sdm660_64/obj/KERNEL_OBJ/usr/techpack/audio/include -I out/target/product/sdm660_64/obj/include/mm-audio/sound_trigger -I out/target/product/sdm660_64/obj/include/mm-audio/audio-log-utils -I vendor/qcom/opensource/audio-hal/primary-hal/hal -I out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates -I out/target/product/sdm660_64/gen/SHARED_LIBRARIES/audio.primary.sdm660_intermediates \$(cat out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/import_includes)   -isystem out/target/product/sdm660_64/obj/include -c  -Werror=implicit-function-declaration -DANDROID -fmessage-length=0 -W -Wall -Wno-unused -Winit-self -Wpointer-arith -no-canonical-prefixes -DNDEBUG -UDEBUG -fno-exceptions -Wno-multichar -O2 -g -fno-strict-aliasing -fdebug-prefix-map=/proc/self/cwd= -D__compiler_offsetof=__builtin_offsetof -faddrsig -Wimplicit-fallthrough -Werror=int-conversion -Wno-reserved-id-macro -Wno-format-pedantic -Wno-unused-command-line-argument -fcolor-diagnostics -Wno-zero-as-null-pointer-constant -Wno-sign-compare -Wno-defaulted-function-deleted -Wno-inconsistent-missing-override -ffunction-sections -fdata-sections -fno-short-enums -funwind-tables -fstack-protector-strong -Wa,--noexecstack -D_FORTIFY_SOURCE=2 -Wstrict-aliasing=2 -Werror=return-type -Werror=non-virtual-dtor -Werror=address -Werror=sequence-point -Werror=date-time -Werror=format-security -nostdlibinc -march=armv8-a  -target aarch64-linux-android -Bprebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/aarch64-linux-android/bin   -std=gnu99    -DPLATFORM_MSMFALCON -DMAX_TARGET_SPECIFIC_CHANNEL_CNT=\"8\" -Wno-macro-redefined -DUSE_VENDOR_EXTN -DHW_VARIANTS_ENABLED -DTFA98XX_ENABLED -DSOUND_TRIGGER_ENABLED -DSOUND_TRIGGER_PLATFORM_NAME=sdm660 -DAUDIO_GENERIC_EFFECT_FRAMEWORK_ENABLED -DDYNAMIC_LOG_ENABLED -D_GNU_SOURCE -Wall -Werror -DARCHERMIND_ALGO_USING -D__ANDROID_API__=29 -D__ANDROID_VNDK__ -fPIC -D_USING_LIBCXX -DANDROID_STRICT   -Werror=int-to-pointer-cast -Werror=pointer-to-int-cast -Werror=address-of-temporary -Werror=return-type -Wno-tautological-constant-compare -Wno-tautological-type-limit-compare -Wno-tautological-unsigned-enum-zero-compare -Wno-tautological-unsigned-zero-compare -Wno-c++98-compat-extra-semi -Wno-return-std-move-in-c++11   -MD -MF out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/audio_hw.d -o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/audio_hw.o vendor/qcom/opensource/audio-hal/primary-hal/hal/audio_hw.c"
```



> 编译流程
>
> audio.primary.sdm660.so

```c++
# 获取快速编译某库的方法
# 删除Android.mk中的某动态库依赖，然后编译会报错。报错log中包含编译方法。

/bin/bash -c "vendor/qcom/proprietary/llvm-arm-toolchain-ship/8.0/bin/clang++ -nostdlib -Wl,-soname,audio.primary.sdm660.so -Wl,--gc-sections -shared out/soong/.intermediates/bionic/libc/crtbegin_so/android_arm64_armv8-a_vendor/crtbegin_so.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/audio_extn/audio_hidl.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/callstack.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/audio_perf.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/audio_hw.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/acdb.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/platform_info.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/msm8974/platform.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/voice.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/audio_extn/audio_extn.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/audio_extn/compress_in.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/audio_extn/fm.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/audio_extn/keep_alive.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/audio_extn/source_track.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/audio_extn/usb.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/audio_extn/utils.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/voice_extn/compress_voip.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/voice_extn/voice_extn.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/msm8974/hw_info.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/audio_extn/tfa98xx_feedback.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/audio_extn/soundtrigger.o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/audio_extn/gef.o -Wl,--whole-archive  -Wl,--no-whole-archive   out/target/product/sdm660_64/obj/STATIC_LIBRARIES/libclang_rt.ubsan_minimal-aarch64-android.vendor_intermediates/libclang_rt.ubsan_minimal-aarch64-android.vendor.a   prebuilts/clang/host/linux-x86/clang-r353983c/lib64/clang/9.0.3/lib/linux//libclang_rt.builtins-aarch64-android.a out/target/product/sdm660_64/obj/STATIC_LIBRARIES/libatomic_intermediates/libatomic.a out/target/product/sdm660_64/obj/STATIC_LIBRARIES/libgcc_intermediates/libgcc.a -Wl,-z,noexecstack -Wl,-z,relro -Wl,-z,now -Wl,--build-id=md5 -Wl,--warn-shared-textrel -Wl,--fatal-warnings -Wl,--no-undefined-version -Wl,--exclude-libs,libgcc.a -Wl,--exclude-libs,libgcc_stripped.a -fuse-ld=lld -Wl,--hash-style=gnu -Wl,--icf=safe -Wl,-z,max-page-size=4096    -target aarch64-linux-android -Bprebuilts/gcc/linux-x86/aarch64/aarch64-linux-android-4.9/aarch64-linux-android/bin -Wl,-execute-only -Wl,--exclude-libs,libclang_rt.ubsan_minimal-aarch64-android.a -Wl,--no-undefined  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libbase.vendor_intermediates/libbase.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/liblog.vendor_intermediates/liblog.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libcutils.vendor_intermediates/libcutils.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libtinyalsa.vendor_intermediates/libtinyalsa.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libtinycompress_intermediates/libtinycompress.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libaudioroute.vendor_intermediates/libaudioroute.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libaudioutils.vendor_intermediates/libaudioutils.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libexpat.vendor_intermediates/libexpat.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libhwbinder.vendor_intermediates/libhwbinder.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libhidlbase.vendor_intermediates/libhidlbase.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libhidltransport.vendor_intermediates/libhidltransport.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libprocessgroup.vendor_intermediates/libprocessgroup.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libutils.vendor_intermediates/libutils.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libutils.vendor_intermediates/libutils.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libaudio_log_utils_intermediates/libaudio_log_utils.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libbase.vendor_intermediates/libbase.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libhidlbase.vendor_intermediates/libhidlbase.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libhwbinder.vendor_intermediates/libhwbinder.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libutils.vendor_intermediates/libutils.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/android.hardware.power@1.2.vendor_intermediates/android.hardware.power@1.2.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/liblog.vendor_intermediates/liblog.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libc++.vendor_intermediates/libc++.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libc.vendor_intermediates/libc.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libm.vendor_intermediates/libm.vendor.so  out/target/product/sdm660_64/obj/SHARED_LIBRARIES/libdl.vendor_intermediates/libdl.vendor.so -o out/target/product/sdm660_64/obj/SHARED_LIBRARIES/audio.primary.sdm660_intermediates/LINKED/audio.primary.sdm660.so out/soong/.intermediates/bionic/libc/crtend_so/android_arm64_armv8-a_vendor/obj/bionic/libc/arch-common/bionic/crtend_so.o"
```